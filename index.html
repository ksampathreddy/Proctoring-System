<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Exam Proctoring System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 1000px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }
        
        header {
            background: #1a2a6c;
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .status-bar {
            display: flex;
            justify-content: space-between;
            background: #2c3e50;
            color: white;
            padding: 10px 20px;
        }
        
        .main-content {
            display: flex;
            padding: 20px;
            gap: 20px;
        }
        
        .exam-section {
            flex: 2;
        }
        
        .monitoring-section {
            flex: 1;
            border-left: 2px solid #eee;
            padding-left: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .question {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        h2 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .options {
            list-style: none;
            margin-top: 15px;
        }
        
        .options li {
            padding: 10px;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .options li:hover {
            background: #e9ecef;
        }
        
        .video-container {
            width: 100%;
            background: #1c1c1c;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }
        
        #video {
            width: 100%;
            display: block;
        }
        
        .face-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .eye-marker {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(0, 255, 0, 0.5);
            transform: translate(-50%, -50%);
        }
        
        .metrics {
            width: 100%;
            background: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .metric {
            margin-bottom: 10px;
        }
        
        .gauge {
            height: 10px;
            background: #4a4a4a;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 5px;
        }
        
        .gauge-fill {
            height: 100%;
            background: #fdbb2d;
            width: 30%;
        }
        
        .warning {
            color: #e74c3c;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
            animation: blink 1s infinite;
        }
        
        @keyframes blink {
            50% { opacity: 0.5; }
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
        }
        
        button {
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        #start-exam {
            background: #27ae60;
            color: white;
        }
        
        #start-exam:hover {
            background: #219653;
        }
        
        #submit-exam {
            background: #3498db;
            color: white;
        }
        
        #submit-exam:hover {
            background: #2980b9;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 500px;
            width: 90%;
        }
        
        .modal h2 {
            color: #e74c3c;
            margin-bottom: 20px;
        }
        
        .modal p {
            margin-bottom: 20px;
            font-size: 18px;
        }
        
        footer {
            text-align: center;
            padding: 15px;
            background: #f8f9fa;
            color: #6c757d;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .monitoring-section {
                border-left: none;
                border-top: 2px solid #eee;
                padding-left: 0;
                padding-top: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>AI-Powered Exam Proctoring System</h1>
            <p>Eye tracking technology for academic integrity</p>
        </header>
        
        <div class="status-bar">
            <div class="time">Time Remaining: <span id="timer">30:00</span></div>
            <div class="status">Status: <span id="status">Not Started</span></div>
            <div class="warning-count">Warnings: <span id="warning-count">0/3</span></div>
        </div>
        
        <div class="main-content">
            <div class="exam-section">
                <div class="question">
                    <h2>Question 1</h2>
                    <p>What is the time complexity of a binary search algorithm?</p>
                    <ul class="options">
                        <li>A) O(n)</li>
                        <li>B) O(n log n)</li>
                        <li>C) O(log n)</li>
                        <li>D) O(1)</li>
                    </ul>
                </div>
                
                <div class="question">
                    <h2>Question 2</h2>
                    <p>Which of the following is NOT a principle of object-oriented programming?</p>
                    <ul class="options">
                        <li>A) Encapsulation</li>
                        <li>B) Inheritance</li>
                        <li>C) Compilation</li>
                        <li>D) Polymorphism</li>
                    </ul>
                </div>
                
                <div class="question">
                    <h2>Question 3</h2>
                    <p>In JavaScript, which keyword is used to declare a variable with block scope?</p>
                    <ul class="options">
                        <li>A) var</li>
                        <li>B) let</li>
                        <li>C) const</li>
                        <li>D) variable</li>
                    </ul>
                </div>
            </div>
            
            <div class="monitoring-section">
                <h2>AI Proctoring</h2>
                <div class="video-container">
                    <video id="video" autoplay playsinline></video>
                    <div class="face-overlay" id="face-overlay">
                        <!-- Eye markers will be placed here by JavaScript -->
                    </div>
                </div>
                
                <div class="metrics">
                    <div class="metric">
                        <div>Eye Deviation: <span id="eye-deviation">0%</span></div>
                        <div class="gauge">
                            <div class="gauge-fill" id="eye-gauge"></div>
                        </div>
                    </div>
                    
                    <div class="metric">
                        <div>Head Position: <span id="head-position">0%</span></div>
                        <div class="gauge">
                            <div class="gauge-fill" id="head-gauge"></div>
                        </div>
                    </div>
                    
                    <div class="metric">
                        <div>Gaze Stability: <span id="gaze-stability">100%</span></div>
                        <div class="gauge">
                            <div class="gauge-fill" id="gaze-gauge" style="width: 100%; background: #2ecc71;"></div>
                        </div>
                    </div>
                    
                    <div class="warning" id="warning-message">
                        Warning: Please look at the screen!
                    </div>
                </div>
                
                <div class="controls">
                    <button id="start-exam">Start Exam</button>
                    <button id="submit-exam">Submit Exam</button>
                </div>
            </div>
        </div>
        
        <footer>
            <p>AI Exam Proctoring System &copy; 2023 | Uses TensorFlow.js for eye tracking</p>
        </footer>
    </div>
    
    <div class="modal" id="warning-modal">
        <div class="modal-content">
            <h2>Warning!</h2>
            <p>You are looking away from the screen too frequently.</p>
            <p>This is your final warning. The exam will be terminated if this continues.</p>
            <button id="acknowledge-warning">Acknowledge</button>
        </div>
    </div>
    
    <div class="modal" id="termination-modal">
        <div class="modal-content">
            <h2>Exam Terminated</h2>
            <p>Your exam has been terminated due to suspicious eye movements.</p>
            <p>Please contact your instructor for further instructions.</p>
        </div>
    </div>

    <!-- Load TensorFlow.js and FaceMesh model -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-converter"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection"></script>

    <script>
        // DOM Elements
        const video = document.getElementById('video');
        const startExamBtn = document.getElementById('start-exam');
        const submitExamBtn = document.getElementById('submit-exam');
        const eyeDeviation = document.getElementById('eye-deviation');
        const headPosition = document.getElementById('head-position');
        const gazeStability = document.getElementById('gaze-stability');
        const eyeGauge = document.getElementById('eye-gauge');
        const headGauge = document.getElementById('head-gauge');
        const gazeGauge = document.getElementById('gaze-gauge');
        const warningMessage = document.getElementById('warning-message');
        const warningModal = document.getElementById('warning-modal');
        const terminationModal = document.getElementById('termination-modal');
        const acknowledgeWarning = document.getElementById('acknowledge-warning');
        const statusText = document.getElementById('status');
        const timerDisplay = document.getElementById('timer');
        const warningCountDisplay = document.getElementById('warning-count');
        const faceOverlay = document.getElementById('face-overlay');
        
        // State variables
        let examStarted = false;
        let eyeDeviationValue = 0;
        let headPositionValue = 0;
        let gazeStabilityValue = 100;
        let warningCount = 0;
        let examTimer;
        let timeLeft = 1800; // 30 minutes in seconds
        let faceDetectionModel;
        let detectionInterval;
        let leftEyePos = { x: 0, y: 0 };
        let rightEyePos = { x: 0, y: 0 };
        
        // Initialize the page
        warningMessage.style.display = 'none';
        submitExamBtn.disabled = true;
        
        // Event Listeners
        startExamBtn.addEventListener('click', startExam);
        submitExamBtn.addEventListener('click', submitExam);
        acknowledgeWarning.addEventListener('click', () => {
            warningModal.style.display = 'none';
        });
        
        // Function to start the exam
        async function startExam() {
            if (!examStarted) {
                examStarted = true;
                statusText.textContent = 'In Progress';
                startExamBtn.textContent = 'Exam Started';
                startExamBtn.disabled = true;
                submitExamBtn.disabled = false;
                
                // Start camera and face detection
                await initCamera();
                await loadFaceDetectionModel();
                startFaceDetection();
                
                // Start monitoring
                startMonitoring();
                
                // Start timer
                startTimer();
            }
        }
        
        // Function to submit the exam
        function submitExam() {
            examStarted = false;
            statusText.textContent = 'Submitted';
            clearInterval(examTimer);
            clearInterval(detectionInterval);
            
            // Stop camera
            stopCamera();
            
            alert('Exam submitted successfully!');
        }
        
        // Initialize camera
        async function initCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user' 
                    } 
                });
                video.srcObject = stream;
                
                return new Promise(resolve => {
                    video.onloadedmetadata = () => {
                        resolve();
                    };
                });
            } catch (err) {
                console.error('Error accessing camera:', err);
                alert('Cannot access camera. Please check permissions.');
            }
        }
        
        // Load FaceMesh model
        async function loadFaceDetectionModel() {
            await tf.setBackend('webgl');
            faceDetectionModel = await faceLandmarksDetection.load(
                faceLandmarksDetection.SupportedPackages.mediapipeFacemesh
            );
        }
        
        // Start face detection
        function startFaceDetection() {
            detectionInterval = setInterval(async () => {
                if (examStarted && video.readyState === 4) {
                    const predictions = await faceDetectionModel.estimateFaces({
                        input: video
                    });
                    
                    if (predictions.length > 0) {
                        updateEyePositions(predictions[0]);
                        calculateEyeDeviation();
                    }
                }
            }, 500);
        }
        
        // Update eye positions based on face mesh
        function updateEyePositions(prediction) {
            // The facemesh model returns 486 landmarks
            // Left eye landmarks: [33, 133]
            // Right eye landmarks: [362, 263]
            
            const leftEye = prediction.annotations.leftEyeIris[0];
            const rightEye = prediction.annotations.rightEyeIris[0];
            
            // Convert normalized coordinates to pixel coordinates
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            
            leftEyePos = {
                x: leftEye[0] * videoWidth,
                y: leftEye[1] * videoHeight
            };
            
            rightEyePos = {
                x: rightEye[0] * videoWidth,
                y: rightEye[1] * videoHeight
            };
            
            // Update eye markers on overlay
            updateEyeMarkers();
        }
        
        // Update eye markers on the video overlay
        function updateEyeMarkers() {
            // Clear previous markers
            faceOverlay.innerHTML = '';
            
            // Calculate scaling factors for overlay
            const videoWidth = video.videoWidth;
            const videoHeight = video.videoHeight;
            const containerWidth = video.offsetWidth;
            const containerHeight = video.offsetHeight;
            
            const scaleX = containerWidth / videoWidth;
            const scaleY = containerHeight / videoHeight;
            
            // Create left eye marker
            const leftEyeMarker = document.createElement('div');
            leftEyeMarker.className = 'eye-marker';
            leftEyeMarker.style.left = `${leftEyePos.x * scaleX}px`;
            leftEyeMarker.style.top = `${leftEyePos.y * scaleY}px`;
            faceOverlay.appendChild(leftEyeMarker);
            
            // Create right eye marker
            const rightEyeMarker = document.createElement('div');
            rightEyeMarker.className = 'eye-marker';
            rightEyeMarker.style.left = `${rightEyePos.x * scaleX}px`;
            rightEyeMarker.style.top = `${rightEyePos.y * scaleY}px`;
            faceOverlay.appendChild(rightEyeMarker);
        }
        
        // Calculate eye deviation (simulated)
        function calculateEyeDeviation() {
            // In a real implementation, this would calculate based on eye positions
            // For simulation, we'll generate random values
            
            eyeDeviationValue = Math.min(100, Math.floor(Math.random() * 110));
            headPositionValue = Math.min(100, Math.floor(Math.random() * 105));
            
            // Update UI
            eyeDeviation.textContent = `${eyeDeviationValue}%`;
            headPosition.textContent = `${headPositionValue}%`;
            eyeGauge.style.width = `${eyeDeviationValue}%`;
            headGauge.style.width = `${headPositionValue}%`;
            
            // Change color based on value
            eyeGauge.style.background = eyeDeviationValue < 50 ? '#2ecc71' : 
                                      eyeDeviationValue < 70 ? '#f39c12' : '#e74c3c';
            
            headGauge.style.background = headPositionValue < 50 ? '#2ecc71' : 
                                       headPositionValue < 70 ? '#f39c12' : '#e74c3c';
            
            // Calculate gaze stability (inverse of deviation)
            gazeStabilityValue = Math.max(0, 100 - eyeDeviationValue - headPositionValue/2);
            gazeStability.textContent = `${gazeStabilityValue}%`;
            gazeGauge.style.width = `${gazeStabilityValue}%`;
            gazeGauge.style.background = gazeStabilityValue > 70 ? '#2ecc71' : 
                                       gazeStabilityValue > 50 ? '#f39c12' : '#e74c3c';
            
            // Show warning if values are too high
            if (eyeDeviationValue > 70 || headPositionValue > 70 || gazeStabilityValue < 50) {
                warningMessage.style.display = 'block';
                
                // If values are critical, show warning modal
                if (eyeDeviationValue > 85 || headPositionValue > 85 || gazeStabilityValue < 30) {
                    warningCount++;
                    warningCountDisplay.textContent = `${warningCount}/3`;
                    
                    if (warningCount >= 3) {
                        terminateExam();
                    } else if (warningCount >= 2) {
                        warningModal.style.display = 'flex';
                    }
                }
            } else {
                warningMessage.style.display = 'none';
            }
        }
        
        // Stop camera
        function stopCamera() {
            const stream = video.srcObject;
            if (stream) {
                const tracks = stream.getTracks();
                tracks.forEach(track => track.stop());
                video.srcObject = null;
            }
        }
        
        // Start monitoring (simulated)
        function startMonitoring() {
            // Simulate monitoring with random values
            setInterval(() => {
                if (examStarted) {
                    // This is now handled by the face detection function
                }
            }, 2000);
        }
        
        // Terminate exam
        function terminateExam() {
            examStarted = false;
            statusText.textContent = 'Terminated';
            clearInterval(examTimer);
            clearInterval(detectionInterval);
            stopCamera();
            terminationModal.style.display = 'flex';
            submitExamBtn.disabled = true;
        }
        
        // Start timer
        function startTimer() {
            examTimer = setInterval(() => {
                if (timeLeft <= 0) {
                    clearInterval(examTimer);
                    submitExam();
                    alert('Time is up! Your exam has been submitted.');
                } else {
                    timeLeft--;
                    updateTimerDisplay();
                }
            }, 1000);
        }
        
        // Update timer display
        function updateTimerDisplay() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Initial timer display
        updateTimerDisplay();
    </script>
</body>
</html>